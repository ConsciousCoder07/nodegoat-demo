name: KICS IaC Scan

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  kics-scan:
    runs-on: ubuntu-latest

    steps:
      # Checkout Repo
      - uses: actions/checkout@v3

      # Ensure results folder exists
      - name: Create KICS results directory
        run: mkdir -p kics-result

      # Run KICS Scan
      - name: Run KICS Scan
        uses: checkmarx/kics-github-action@latest
        with:
          path: '.'
          output_formats: 'json,html,sarif'
          output_path: 'kics-result'
          fail_on: ''    # prevents unexpected pipeline failures

      # Display results.json in console (optional but helpful)
      - name: Display KICS JSON Results
        if: always()
        run: |
          if [ -f kics-result/results.json ]; then
            cat kics-result/results.json
          else
            echo "No results.json found."
          fi

      # Upload all reports (HTML, JSON, SARIF)
      - name: Upload KICS Reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: kics-reports
          path: kics-result/*